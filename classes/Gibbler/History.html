<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>: Gibbler::History [Gibbler: Git-like hashes for Ruby objects]</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <link href='../../rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>Module</span>
          Gibbler::History
        </h1>
        <ol class='paths'>
          <li>
            <a href="../../files/lib/gibbler/history_rb.html">lib/gibbler/history.rb</a>
          </li>
        </ol>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public class</h3>
            <ol>
              <li><a href="#M000016">mutex</a></li>
            </ol>
            <h3>public instance</h3>
            <ol>
              <li><a href="#M000020">gibbler_commit</a></li>
              <li><a href="#M000024">gibbler_find_long</a></li>
              <li><a href="#M000017">gibbler_history</a></li>
              <li><a href="#M000023">gibbler_history?</a></li>
              <li><a href="#M000018">gibbler_object</a></li>
              <li><a href="#M000021">gibbler_revert</a></li>
              <li><a href="#M000019">gibbler_stamp</a></li>
              <li><a href="#M000022">gibbler_valid?</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='methods'>
              <h2>Public class methods</h2>
              <div class='public-class method' id='method-M000016'>
                <a name='M000016'>      </a>
                <div class='synopsis'>
                  <span class='name'>mutex</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000016-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000016-source'>    <span class="ruby-comment cmt"># File lib/gibbler/history.rb, line 19</span>&#x000A;19:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">mutex</span>; <span class="ruby-ivar">@@mutex</span>; <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Public instance methods</h2>
              <div class='public-instance method' id='method-M000020'>
                <a name='M000020'>      </a>
                <div class='synopsis'>
                  <span class='name'>gibbler_commit</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  Stores a clone of the current object instance using the current digest
                  value. If the object was not changed, this method does nothing but return
                  the gibble.
                  </p>
                  <p>
                  NOTE: This method is not fully thread safe. It uses a Mutex.synchronize but
                  there&#8217;s a race condition where two threads can attempt to commit at
                  near the same time. The first will get the lock and create the commit. The
                  second will get the lock and create another commit immediately after. What
                  we probably want is for the second thread to return the digest for that
                  first snapshot, but how do we know this was a result of the race conditioon
                  rather than two legitimate calls for a snapshot?
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000020-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000020-source'>    <span class="ruby-comment cmt"># File lib/gibbler/history.rb, line 68</span>&#x000A;68:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gibbler_commit</span>&#x000A;69:       <span class="ruby-identifier">now</span>, <span class="ruby-identifier">digest</span>, <span class="ruby-identifier">point</span> = <span class="ruby-keyword kw">nil</span>,<span class="ruby-keyword kw">nil</span>,<span class="ruby-keyword kw">nil</span>&#x000A;70:       &#x000A;71:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@__gibbler_history__</span>.<span class="ruby-identifier">nil?</span>&#x000A;72:         <span class="ruby-ivar">@@mutex</span>.<span class="ruby-identifier">synchronize</span> {&#x000A;73:           <span class="ruby-ivar">@__gibbler_history__</span> <span class="ruby-operator">||=</span> { <span class="ruby-identifier">:history</span> =<span class="ruby-operator">&gt;</span> [], <span class="ruby-identifier">:objects</span> =<span class="ruby-operator">&gt;</span> {}, <span class="ruby-identifier">:stamp</span> =<span class="ruby-operator">&gt;</span> {} }&#x000A;74:         }&#x000A;75:       <span class="ruby-keyword kw">end</span>&#x000A;76:       &#x000A;77:       <span class="ruby-ivar">@@mutex</span>.<span class="ruby-identifier">synchronize</span> {&#x000A;78:         <span class="ruby-identifier">now</span>, <span class="ruby-identifier">digest</span>, <span class="ruby-identifier">point</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>, <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">gibbler</span>, <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">clone</span>&#x000A;79:         <span class="ruby-ivar">@__gibbler_history__</span>[<span class="ruby-identifier">:history</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">digest</span>&#x000A;80:         <span class="ruby-ivar">@__gibbler_history__</span>[<span class="ruby-identifier">:stamp</span>][<span class="ruby-identifier">digest</span>] = <span class="ruby-identifier">now</span>&#x000A;81:         <span class="ruby-ivar">@__gibbler_history__</span>[<span class="ruby-identifier">:objects</span>][<span class="ruby-identifier">digest</span>] = <span class="ruby-identifier">point</span>&#x000A;82:       }&#x000A;83:       &#x000A;84:       <span class="ruby-identifier">digest</span>&#x000A;85:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000024'>
                <a name='M000024'>      </a>
                <div class='synopsis'>
                  <span class='name'>gibbler_find_long</span>
                  <span class='arguments'>(g)</span>
                </div>
                <div class='description'>
                  <p>
                  Returns the long digest associated to the short digest <tt>g</tt>. If g is
                  longer than 8 characters it returns the value of <tt>g</tt>.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000024-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000024-source'>     <span class="ruby-comment cmt"># File lib/gibbler/history.rb, line 137</span>&#x000A;137:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gibbler_find_long</span>(<span class="ruby-identifier">g</span>)&#x000A;138:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">nil?</span>&#x000A;139:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">g</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">8</span>&#x000A;140:       <span class="ruby-identifier">gibbler_history</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">match</span> <span class="ruby-node">/\A#{g}/</span> }.<span class="ruby-identifier">first</span>&#x000A;141:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000017'>
                <a name='M000017'>      </a>
                <div class='synopsis'>
                  <span class='name'>gibbler_history</span>
                  <span class='arguments'>(short=false)</span>
                </div>
                <div class='description'>
                  <p>
                  Returns an <a href="Array.html">Array</a> of digests in the order they were
                  committed. If <tt>short</tt> is anything but false, the digests will be
                  converted to the short 8 character digests.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000017-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000017-source'>    <span class="ruby-comment cmt"># File lib/gibbler/history.rb, line 24</span>&#x000A;24:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gibbler_history</span>(<span class="ruby-identifier">short</span>=<span class="ruby-keyword kw">false</span>)&#x000A;25:       <span class="ruby-comment cmt"># Only a single thread should attempt to initialize the store.</span>&#x000A;26:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@__gibbler_history__</span>.<span class="ruby-identifier">nil?</span>&#x000A;27:         <span class="ruby-ivar">@@mutex</span>.<span class="ruby-identifier">synchronize</span> {&#x000A;28:           <span class="ruby-ivar">@__gibbler_history__</span> <span class="ruby-operator">||=</span> { <span class="ruby-identifier">:history</span> =<span class="ruby-operator">&gt;</span> [], <span class="ruby-identifier">:objects</span> =<span class="ruby-operator">&gt;</span> {}, <span class="ruby-identifier">:stamp</span> =<span class="ruby-operator">&gt;</span> {} }&#x000A;29:         }&#x000A;30:       <span class="ruby-keyword kw">end</span>&#x000A;31:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">short</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">false</span>&#x000A;32:         <span class="ruby-ivar">@__gibbler_history__</span>[<span class="ruby-identifier">:history</span>]&#x000A;33:       <span class="ruby-keyword kw">else</span>&#x000A;34:         <span class="ruby-ivar">@__gibbler_history__</span>[<span class="ruby-identifier">:history</span>].<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">short</span> }&#x000A;35:       <span class="ruby-keyword kw">end</span>&#x000A;36:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000023'>
                <a name='M000023'>      </a>
                <div class='synopsis'>
                  <span class='name'>gibbler_history?</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  Does the current object have any history?
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000023-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000023-source'>     <span class="ruby-comment cmt"># File lib/gibbler/history.rb, line 131</span>&#x000A;131:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gibbler_history?</span>&#x000A;132:       <span class="ruby-operator">!</span><span class="ruby-identifier">gibbler_history</span>.<span class="ruby-identifier">empty?</span>&#x000A;133:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000018'>
                <a name='M000018'>      </a>
                <div class='synopsis'>
                  <span class='name'>gibbler_object</span>
                  <span class='arguments'>(g=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Returns the object stored under the given digest <tt>g</tt>. If <tt>g</tt>
                  is not a valid digest, returns nil.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000018-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000018-source'>    <span class="ruby-comment cmt"># File lib/gibbler/history.rb, line 40</span>&#x000A;40:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gibbler_object</span>(<span class="ruby-identifier">g</span>=<span class="ruby-keyword kw">nil</span>) &#x000A;41:       <span class="ruby-identifier">g</span> = <span class="ruby-identifier">gibbler_find_long</span> <span class="ruby-identifier">g</span>&#x000A;42:       <span class="ruby-identifier">g</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">gibbler_history</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">nil?</span>&#x000A;43: &#x000A;44:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">gibbler_valid?</span> <span class="ruby-identifier">g</span>&#x000A;45:       <span class="ruby-ivar">@__gibbler_history__</span>[<span class="ruby-identifier">:objects</span>][ <span class="ruby-identifier">g</span> ]&#x000A;46:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000021'>
                <a name='M000021'>      </a>
                <div class='synopsis'>
                  <span class='name'>gibbler_revert</span>
                  <span class='arguments'>(g=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Revert this object to a previously known state. If called without arguments
                  it will revert to the most recent commit. If a digest is specified
                  <tt>g</tt>, it will revert to that point.
                  </p>
                  <p>
                  Ruby does not support replacing self (<tt>self = previous_self</tt>) so
                  each object type needs to implement its own __gibbler_revert method. This
                  default run some common checks and then defers to self.__gibbler_revert.
                  </p>
                  <p>
                  Raise the following exceptions:
                  </p>
                  <ul>
                  <li>NoRevert: if this object doesn&#8217;t have a __gibbler_revert method
                  
                  </li>
                  <li>NoHistory: This object has no commits
                  
                  </li>
                  <li>BadDigest: The given digest is not in the history for this object
                  
                  </li>
                  </ul>
                  <p>
                  If <tt>g</tt> matches the current digest value this method does nothing.
                  </p>
                  <p>
                  Returns the new digest (<tt>g</tt>).
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000021-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000021-source'>     <span class="ruby-comment cmt"># File lib/gibbler/history.rb, line 103</span>&#x000A;103:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gibbler_revert</span>(<span class="ruby-identifier">g</span>=<span class="ruby-keyword kw">nil</span>)&#x000A;104:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">NoRevert</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:__gibbler_revert</span>)&#x000A;105:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">NoHistory</span>, <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">gibbler_history?</span>&#x000A;106:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadDigest</span>, <span class="ruby-identifier">g</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">g</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">gibbler_valid?</span>(<span class="ruby-identifier">g</span>)&#x000A;107:       &#x000A;108:       <span class="ruby-identifier">g</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">gibbler_history</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">nil?</span>&#x000A;109:       <span class="ruby-identifier">g</span> = <span class="ruby-identifier">gibbler_find_long</span> <span class="ruby-identifier">g</span> &#x000A;110:       &#x000A;111:       <span class="ruby-comment cmt"># Do nothing if the given digest matches the current gibble. </span>&#x000A;112:       <span class="ruby-comment cmt"># NOTE: We use __gibbler b/c it doesn't update @@__gibbler_digest__.</span>&#x000A;113:       <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">__gibbler</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">g</span>&#x000A;114:         <span class="ruby-ivar">@@mutex</span>.<span class="ruby-identifier">synchronize</span> {&#x000A;115:           <span class="ruby-comment cmt"># Always make sure @__gibbler_digest__ is a Gibbler::Digest </span>&#x000A;116:           <span class="ruby-ivar">@__gibbler_digest__</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Gibbler</span><span class="ruby-operator">::</span><span class="ruby-constant">Digest</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">g</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Gibbler</span><span class="ruby-operator">::</span><span class="ruby-constant">Digest</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">g</span>)&#x000A;117:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">__gibbler_revert</span>&#x000A;118:         }&#x000A;119:       <span class="ruby-keyword kw">end</span>&#x000A;120:       &#x000A;121:       <span class="ruby-ivar">@__gibbler_digest__</span>&#x000A;122:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000019'>
                <a name='M000019'>      </a>
                <div class='synopsis'>
                  <span class='name'>gibbler_stamp</span>
                  <span class='arguments'>(g=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Returns the timestamp (a Time object) when the digest <tt>g</tt> was
                  committed. If <tt>g</tt> is not a valid gibble, returns nil.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000019-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000019-source'>    <span class="ruby-comment cmt"># File lib/gibbler/history.rb, line 50</span>&#x000A;50:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gibbler_stamp</span>(<span class="ruby-identifier">g</span>=<span class="ruby-keyword kw">nil</span>)&#x000A;51:       <span class="ruby-identifier">g</span> = <span class="ruby-identifier">gibbler_find_long</span> <span class="ruby-identifier">g</span>&#x000A;52:       <span class="ruby-identifier">g</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">gibbler_history</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">nil?</span>&#x000A;53:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">gibbler_valid?</span> <span class="ruby-identifier">g</span>&#x000A;54:       <span class="ruby-ivar">@__gibbler_history__</span>[<span class="ruby-identifier">:stamp</span>][ <span class="ruby-identifier">g</span> ]&#x000A;55:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000022'>
                <a name='M000022'>      </a>
                <div class='synopsis'>
                  <span class='name'>gibbler_valid?</span>
                  <span class='arguments'>(g)</span>
                </div>
                <div class='description'>
                  <p>
                  Is the given digest <tt>g</tt> contained in the history for this object?
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000022-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000022-source'>     <span class="ruby-comment cmt"># File lib/gibbler/history.rb, line 125</span>&#x000A;125:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gibbler_valid?</span>(<span class="ruby-identifier">g</span>)&#x000A;126:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">gibbler_history?</span>&#x000A;127:       <span class="ruby-identifier">gibbler_history</span>.<span class="ruby-identifier">member?</span> <span class="ruby-identifier">gibbler_find_long</span>(<span class="ruby-identifier">g</span>)&#x000A;128:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
